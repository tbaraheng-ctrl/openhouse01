<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.S OPEN HOUSE 2026 Registration</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Prompt -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS (XLSX) for Excel Import/Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; }
        .text-navy { color: #002147; }
        .bg-navy { background-color: #002147; }
        .hover-bg-navy:hover { background-color: #001a38; }
        .text-gold { color: #C5A059; }
        .border-gold { border-color: #C5A059; }
        .bg-gold { background-color: #C5A059; }
        
        .tab-btn { color: #64748b; }
        .tab-btn.active { border-bottom: 3px solid #C5A059; color: #002147; font-weight: 600; }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .loading-spinner { border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toggle Switch Style */
        .toggle-checkbox:checked ~ .block {
            background-color: #002147; /* ‡∏™‡∏µ Navy */
        }
        .toggle-checkbox:checked ~ .dot {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen relative">

    <!-- Config script -->
    <script>
        // *** ‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á App Script ‡∏ó‡∏µ‡πà Deploy ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzKvDBsm0oIlEaQ8LTUKEsOO652RJqjq7pLi97uAMw3KAOeUvax3kvEHEeSN1IuurtS/exec';
        
        // ‡∏Ñ‡πà‡∏≤ Default
        let APP_CONFIG = {
            admin_username: 'admin',
            admin_password: '1234',
            target_lat: 6.4255,
            target_lng: 101.8230,
            allowed_radius: 5.0,
            geo_enabled: 'true',
            registration_enabled: 'true', 
            activity_reg_enabled: 'true', 
            popup_enabled: 'false',
            popup_content: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏á‡∏≤‡∏ô N.S OPEN HOUSE 2026',
            popup_link_target: 'checkin'
        };
    </script>

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex flex-col items-center relative">
            <button onclick="switchTab('admin')" class="absolute top-4 right-4 text-gray-300 hover:text-navy transition" title="‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà">
                <i class="fas fa-cog"></i>
            </button>

            <img src="https://www.ns.ac.th/wp-content/uploads/2024/12/cropped-logo-sq.png" alt="NS Logo" class="h-24 w-auto mb-2 drop-shadow-sm">
            <h1 class="text-2xl md:text-3xl font-bold text-navy text-center tracking-wide">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° N.S OPEN HOUSE 2026</h1>
            <p class="text-gray-500 text-sm mt-1">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏£‡∏≤‡∏™‡∏¥‡∏Å‡∏Ç‡∏≤‡∏•‡∏±‡∏¢</p>
        </div>
        
        <!-- Navigation -->
        <nav class="bg-white border-t mt-4 overflow-x-auto shadow-sm">
            <div class="container mx-auto flex justify-center min-w-max">
                <button onclick="switchTab('register')" id="tab-register" class="tab-btn active px-6 py-3 hover:text-navy transition"><i class="fas fa-user-plus mr-2"></i>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
                <button onclick="switchTab('results')" id="tab-results" class="tab-btn px-6 py-3 hover:text-navy transition"><i class="fas fa-trophy mr-2"></i>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</button>
                <button onclick="switchTab('cert')" id="tab-cert" class="tab-btn px-6 py-3 hover:text-navy transition"><i class="fas fa-certificate mr-2"></i>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</button>
                <button onclick="switchTab('checkin')" id="tab-checkin" class="tab-btn px-6 py-3 hover:text-navy transition"><i class="fas fa-map-marker-alt mr-2"></i>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 max-w-5xl">

        <!-- 1. ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° -->
        <section id="page-register" class="fade-in block">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                <h2 class="text-xl font-bold text-navy mb-6 border-l-4 border-gold pl-3">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h2>
                
                <div id="reg-closed-msg" class="hidden text-center py-12">
                    <div class="inline-block p-4 rounded-full bg-red-50 mb-4">
                        <i class="fas fa-clock text-5xl text-red-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-700">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</h3>
                    <p class="text-gray-500 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>
                </div>

                <form id="regForm" onsubmit="submitRegistration(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                        <div class="relative">
                            <select id="reg-activity" onchange="onActivityChange(this)" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy focus:border-transparent appearance-none bg-white">
                                <option value="" data-group="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                            <input type="text" id="reg-group" readonly class="w-full px-3 py-2 border border-gray-200 bg-gray-100 text-gray-600 rounded-lg focus:outline-none cursor-not-allowed" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (1-15 ‡∏Ñ‡∏ô)</label>
                            <select id="reg-count" onchange="renderStudentInputs()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy">
                                <option value="1">1 ‡∏Ñ‡∏ô</option>
                                <option value="2">2 ‡∏Ñ‡∏ô</option>
                                <option value="3">3 ‡∏Ñ‡∏ô</option>
                            </select>
                        </div>
                    </div>

                    <div id="student-inputs-container" class="space-y-3 mb-6 bg-slate-50 p-4 rounded-lg border border-gray-200"></div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                            <input type="text" id="reg-school" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-navy focus:border-navy">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</label>
                            <input type="text" id="reg-teacher" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-navy focus:border-navy">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" id="reg-phone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-navy focus:border-navy">
                        </div>
                    </div>

                    <button type="submit" id="btn-submit-reg" class="w-full bg-navy hover:bg-[#001a38] text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 flex justify-center items-center">
                        <span id="btn-text-reg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
                        <div id="spinner-reg" class="hidden loading-spinner w-5 h-5 border-2 border-white rounded-full ml-2"></div>
                    </button>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-navy">
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 
                        <span id="history-count-badge" class="ml-2 text-sm font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded-full">(0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                    </h3>
                    <button id="btn-refresh-history" onclick="loadRegistrationHistory()" class="text-sm bg-white border border-gray-300 text-gray-600 px-3 py-1 rounded hover:bg-gray-50 transition shadow-sm">
                        <i class="fas fa-sync-alt mr-1 text-gold"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>
                
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-white uppercase bg-navy">
                            <tr>
                                <th class="px-4 py-3 font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
                                <th class="px-4 py-3 font-medium">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                                <th class="px-4 py-3 font-medium">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</th>
                                <th class="px-4 py-3 font-medium">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                <th class="px-4 py-3 font-medium">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody id="reg-history-body" class="divide-y divide-gray-100">
                            <tr><td colspan="5" class="text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 2. ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô -->
        <section id="page-results" class="fade-in hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h2 class="text-xl font-bold text-navy border-l-4 border-gold pl-3">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h2>
                    <button onclick="loadResults()" class="text-sm bg-blue-50 text-navy px-3 py-1 rounded hover:bg-blue-100 border border-blue-100 transition"><i class="fas fa-sync-alt mr-1"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                
                <div class="mb-4 relative">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="filter-result" onkeyup="filterResultsTable()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..." class="w-full pl-10 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-navy focus:outline-none">
                </div>

                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-white uppercase bg-navy">
                            <tr>
                                <th class="px-4 py-3 font-medium">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                                <th class="px-4 py-3 font-medium">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
                                <th class="px-4 py-3 font-medium">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                <th class="px-4 py-3 font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                <th class="px-4 py-3 font-medium">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</th>
                            </tr>
                        </thead>
                        <tbody id="result-table-body" class="divide-y divide-gray-100">
                            <tr><td colspan="5" class="text-center py-8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 3. ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£ -->
        <section id="page-cert" class="fade-in hidden">
            <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 text-center border border-gray-100">
                <div class="mb-6">
                    <i class="fas fa-medal text-6xl text-gold mb-4 drop-shadow-sm"></i>
                    <h2 class="text-2xl font-bold text-navy">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</h2>
                    <p class="text-gray-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡πá‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ)</p>
                </div>

                <div class="flex gap-2 mb-6">
                    <input type="text" id="cert-search-input" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-navy focus:outline-none" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)" onkeypress="if(event.key === 'Enter') searchCertificate()">
                    <button onclick="searchCertificate()" class="bg-navy text-white px-6 py-3 rounded-lg hover:bg-[#001a38] transition shadow-md">
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <div id="cert-result-area" class="text-left space-y-3">
                    <!-- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>
            </div>
        </section>

        <!-- 4. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Check-in) -->
        <section id="page-checkin" class="fade-in hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Count Dashboard -->
                <div class="bg-gradient-to-br from-[#002147] to-[#003366] rounded-2xl p-6 text-white shadow-xl relative overflow-hidden group transform hover:scale-[1.02] transition-all duration-300 border border-white/10">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-[#C5A059]/20 rounded-full blur-3xl"></div>
                    <div class="absolute -left-6 -bottom-6 w-32 h-32 bg-blue-400/10 rounded-full blur-3xl"></div>
                    <div class="relative z-10 flex flex-col h-full justify-between">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-gray-300 text-sm font-medium uppercase tracking-wider mb-1">‡∏¢‡∏≠‡∏î‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°</h3>
                                <div class="flex items-center gap-2">
                                    <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
                                    <span class="text-xs text-green-300 font-light">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</span>
                                </div>
                            </div>
                            <div class="p-3 bg-white/10 rounded-lg backdrop-blur-sm shadow-inner"><i class="fas fa-users text-2xl text-[#C5A059]"></i></div>
                        </div>
                        <div class="mt-6 flex items-baseline gap-2">
                            <span class="text-5xl font-bold text-white tracking-tight drop-shadow-sm" id="checkin-count">0</span>
                            <span class="text-lg text-gray-300 font-light">‡∏Ñ‡∏ô</span>
                        </div>
                    </div>
                </div>

                <!-- Geo Status Dashboard -->
                <div id="geo-status-container" class="md:col-span-2 bg-white rounded-2xl p-6 shadow-lg flex items-center justify-center border border-gray-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-green-500"></div>
                    <div class="text-center z-10">
                        <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 text-green-600 mb-3"><i class="fas fa-map-marker-alt text-xl"></i></div>
                        <h3 class="text-lg font-bold text-navy">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                        <p id="geo-status" class="text-gray-500 mt-1 font-medium"><i class="fas fa-spinner fa-spin mr-1"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</p>
                        <p id="geo-disabled-msg" class="text-sm text-yellow-600 mt-2 bg-yellow-50 px-3 py-1 rounded-full hidden border border-yellow-100"><i class="fas fa-info-circle mr-1"></i> ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà)</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-navy mb-4">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</h2>
                
                <div id="checkin-closed-msg" class="hidden text-center py-12">
                    <div class="inline-block p-4 rounded-full bg-gray-100 mb-4"><i class="fas fa-lock text-5xl text-gray-400"></i></div>
                    <h3 class="text-2xl font-bold text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                    <p class="text-gray-400 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</p>
                </div>

                <form id="checkinForm" onsubmit="submitCheckin(event)">
                    
                    <!-- ‡πÇ‡∏´‡∏°‡∏î Tab Toggle -->
                    <div class="flex justify-center mb-6 border-b">
                        <button type="button" onclick="toggleCheckinMode('manual')" id="tab-manual" class="px-6 py-2 font-medium text-navy border-b-2 border-navy">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á</button>
                        <button type="button" onclick="toggleCheckinMode('excel')" id="tab-excel" class="px-6 py-2 font-medium text-gray-400 hover:text-navy">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå Excel</button>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô) -->
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <select id="ci-school" onchange="toggleOtherSchoolInput(this)" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy appearance-none bg-white">
                                <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"><i class="fas fa-chevron-down text-xs"></i></div>
                        </div>
                        <input type="text" id="ci-school-other" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy hidden" placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î">
                    </div>

                    <!-- Mode 1: Manual Input -->
                    <div id="checkin-manual-section">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                                <select id="ci-prefix" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option>‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option><option>‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option><option>‡∏ô‡∏≤‡∏¢</option><option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option><option>‡∏ô‡∏≤‡∏á</option><option>‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
                                <input type="text" id="ci-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-navy">
                            </div>
                        </div>
                    </div>

                    <!-- Mode 2: Excel Import -->
                    <div id="checkin-excel-section" class="hidden mb-6">
                        <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-4">
                            <h4 class="font-bold text-navy mb-2"><i class="fas fa-file-excel mr-2"></i>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h4>
                            <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                                <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                                <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <strong>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</strong> ‡πÅ‡∏•‡∏∞ <strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</strong> ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <strong>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</strong> ‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</li>
                                <li>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (.xlsx) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô</li>
                            </ul>
                            <button type="button" onclick="downloadTemplate()" class="mt-3 bg-white border border-green-500 text-green-600 px-4 py-2 rounded-lg text-sm hover:bg-green-50 transition">
                                <i class="fas fa-download mr-1"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° (.xlsx)
                            </button>
                        </div>
                        
                        <div class="mb-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</label>
                            <input type="file" id="ci-excel-file" accept=".xlsx" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-navy file:text-white hover:file:bg-[#001a38]">
                        </div>
                        <div id="excel-preview-count" class="text-sm text-gray-500"></div>
                    </div>

                    <input type="hidden" id="ci-coords">
                    <input type="hidden" id="ci-mode" value="manual"> <!-- Track Mode -->

                    <button type="submit" id="btn-ci-submit" disabled class="w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-lg shadow transition cursor-not-allowed">
                        <i class="fas fa-map-marked-alt mr-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    </button>
                </form>
            </div>
        </section>

        <!-- 5. ‡∏´‡∏ô‡πâ‡∏≤ Admin -->
        <section id="page-admin" class="fade-in hidden">
            <!-- (Admin code same as before, truncated for brevity but maintained in logic) -->
            <div id="admin-login-view" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8 border border-gray-100 mt-10">
                <h2 class="text-2xl font-bold text-navy text-center mb-6">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h2>
                <form onsubmit="adminLogin(event)">
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label><input type="text" id="login-user" class="w-full px-4 py-2 border rounded-lg focus:ring-navy" required></div>
                    <div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="login-pass" class="w-full px-4 py-2 border rounded-lg focus:ring-navy" required></div>
                    <button type="submit" class="w-full bg-navy text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </form>
            </div>
            <div id="admin-dashboard-view" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-navy"><i class="fas fa-cogs mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2><button onclick="adminLogout()" class="text-red-500 text-sm hover:underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>
                    <div class="mb-8 border-b pb-6"><h3 class="text-lg font-bold text-gray-700 mb-4">‚öôÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</h3>
                        <div class="flex items-center mb-4"><label for="toggle-reg" class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="toggle-reg" class="sr-only toggle-checkbox"><div class="block bg-gray-300 w-14 h-8 rounded-full transition"></div><div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition toggle-label"></div></div><div class="ml-3 text-gray-700 font-medium">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô (Check-in)</div></label></div>
                        <div class="flex items-center mb-4"><label for="toggle-act-reg" class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="toggle-act-reg" class="sr-only toggle-checkbox"><div class="block bg-gray-300 w-14 h-8 rounded-full transition"></div><div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition toggle-label"></div></div><div class="ml-3 text-gray-700 font-medium">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô (Activity Register)</div></label></div>
                    </div>
                    <div class="mb-8 border-b pb-6"><h3 class="text-lg font-bold text-gray-700 mb-4">üìç ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                        <div class="flex items-center mb-4"><label for="toggle-geo" class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="toggle-geo" class="sr-only toggle-checkbox"><div class="block bg-gray-300 w-14 h-8 rounded-full transition"></div><div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition toggle-label"></div></div><div class="ml-3 text-gray-700 font-medium">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î (GPS)</div></label></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block text-gray-700 text-sm font-bold mb-2">‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î</label><input type="text" id="admin-lat" class="w-full px-3 py-2 border rounded-lg bg-gray-50"></div><div><label class="block text-gray-700 text-sm font-bold mb-2">‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î</label><input type="text" id="admin-lng" class="w-full px-3 py-2 border rounded-lg bg-gray-50"></div></div>
                        <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">‡∏£‡∏±‡∏®‡∏°‡∏µ (‡∏Å‡∏°.)</label><input type="number" id="admin-radius" step="0.1" class="w-full md:w-1/3 px-3 py-2 border rounded-lg"></div>
                        <button onclick="getCurrentLocationForAdmin()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm mr-2"><i class="fas fa-map-marker-alt mr-1"></i> ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
                    </div>
                    <div class="mb-8 border-b pb-6"><h3 class="text-lg font-bold text-gray-700 mb-4">üì¢ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</h3>
                        <div class="flex items-center mb-4"><label for="toggle-popup" class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="toggle-popup" class="sr-only toggle-checkbox"><div class="block bg-gray-300 w-14 h-8 rounded-full transition"></div><div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition toggle-label"></div></div><div class="ml-3 text-gray-700 font-medium">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</div></label></div>
                        <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û</label><textarea id="admin-popup-content" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea></div>
                        <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">‡∏õ‡∏∏‡πà‡∏°‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà</label><select id="admin-popup-target" class="w-full px-3 py-2 border rounded-lg"><option value="checkin">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Check-in)</option><option value="register">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Register)</option><option value="cert">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£ (Certificate)</option></select></div>
                    </div>
                    <div class="mb-8"><h3 class="text-lg font-bold text-gray-700 mb-4">üîê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-gray-700 text-sm font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</label><input type="text" id="admin-new-user" class="w-full px-3 py-2 border rounded-lg"></div><div><label class="block text-gray-700 text-sm font-bold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input type="text" id="admin-new-pass" class="w-full px-3 py-2 border rounded-lg"></div></div>
                    </div>
                    <button onclick="saveAdminSettings()" id="btn-save-settings" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-navy text-white text-center py-6 mt-8">
        <p class="opacity-80 font-light">&copy; 2026 N.S OPEN HOUSE. Developed for Narasikkhalai School.</p>
    </footer>

    <!-- Homepage Popup Modal -->
    <div id="homepage-popup" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center fade-in">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full mx-4 text-center relative">
            <button onclick="closePopup()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            <div class="mb-4 text-gold"><i class="fas fa-bullhorn text-5xl"></i></div>
            <h3 class="text-2xl font-bold text-navy mb-4">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® / ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</h3>
            <p id="popup-message" class="text-gray-600 mb-6 text-lg"></p>
            <button id="popup-action-btn" onclick="handlePopupAction()" class="bg-navy text-white px-6 py-2 rounded-lg hover:bg-gray-800 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <!-- JavaScript Application Logic -->
    <script>
        let activitiesList = [];

        function switchTab(tabId) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + tabId).classList.remove('hidden');
            const tabBtn = document.getElementById('tab-' + tabId);
            if(tabBtn) tabBtn.classList.add('active');

            if(tabId === 'register') initRegisterPage();
            if(tabId === 'results') loadResults();
            if(tabId === 'checkin') initCheckin();
            if(tabId === 'admin') initAdmin();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initRegisterForm();
            loadSettingsAndInit(); 
        });

        // Config & Settings
        function loadSettingsAndInit() {
            fetch(`${SCRIPT_URL}?action=getSettings`)
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success') {
                    APP_CONFIG = { ...APP_CONFIG, ...res.data };
                    console.log("Settings Loaded:", APP_CONFIG);
                    const isPopupEnabled = (APP_CONFIG.popup_enabled === 'true' || APP_CONFIG.popup_enabled === true);
                    if(isPopupEnabled) {
                        document.getElementById('popup-message').innerText = APP_CONFIG.popup_content;
                        const btn = document.getElementById('popup-action-btn');
                        const target = APP_CONFIG.popup_link_target || 'checkin';
                        if(target === 'checkin') btn.innerText = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
                        else if(target === 'cert') btn.innerText = '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£';
                        else if(target === 'register') btn.innerText = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
                        document.getElementById('homepage-popup').classList.remove('hidden');
                    }
                    const currentTab = document.querySelector('section:not(.hidden)').id.replace('page-', '');
                    if(currentTab === 'checkin') initCheckin();
                    if(currentTab === 'register') initRegisterPage();
                }
            })
            .catch(err => console.error("Config Load Error:", err));
            switchTab('register');
        }

        function closePopup() { document.getElementById('homepage-popup').classList.add('hidden'); }
        function handlePopupAction() { closePopup(); const target = APP_CONFIG.popup_link_target || 'checkin'; switchTab(target); }

        // --- Logic: Check-in & Excel Import ---
        function toggleCheckinMode(mode) {
            document.getElementById('ci-mode').value = mode;
            if (mode === 'manual') {
                document.getElementById('checkin-manual-section').classList.remove('hidden');
                document.getElementById('checkin-excel-section').classList.add('hidden');
                document.getElementById('tab-manual').classList.add('text-navy', 'border-b-2', 'border-navy');
                document.getElementById('tab-manual').classList.remove('text-gray-400');
                document.getElementById('tab-excel').classList.remove('text-navy', 'border-b-2', 'border-navy');
                document.getElementById('tab-excel').classList.add('text-gray-400');
                // Req check
                document.getElementById('ci-name').required = true;
            } else {
                document.getElementById('checkin-manual-section').classList.add('hidden');
                document.getElementById('checkin-excel-section').classList.remove('hidden');
                document.getElementById('tab-excel').classList.add('text-navy', 'border-b-2', 'border-navy');
                document.getElementById('tab-excel').classList.remove('text-gray-400');
                document.getElementById('tab-manual').classList.remove('text-navy', 'border-b-2', 'border-navy');
                document.getElementById('tab-manual').classList.add('text-gray-400');
                // Req check off
                document.getElementById('ci-name').required = false;
            }
        }

        function downloadTemplate() {
            // Create workbook & worksheet
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ["‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤", "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"],
                ["‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢", "‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏û‡∏µ‡∏¢‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤"],
                ["‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á", "‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ"]
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°");
            XLSX.writeFile(wb, "Template_‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô_NS_OpenHouse.xlsx");
        }

        function initCheckin() {
            const statusContainer = document.getElementById('geo-status-container');
            const statusDiv = document.getElementById('geo-status');
            const btn = document.getElementById('btn-ci-submit');
            const geoMsg = document.getElementById('geo-disabled-msg');
            const form = document.getElementById('checkinForm');
            const closedMsg = document.getElementById('checkin-closed-msg');

            const isRegEnabled = (APP_CONFIG.registration_enabled === 'true' || APP_CONFIG.registration_enabled === true);
            if (!isRegEnabled) { form.classList.add('hidden'); closedMsg.classList.remove('hidden'); if(statusContainer) statusContainer.classList.add('hidden'); return; } 
            else { form.classList.remove('hidden'); closedMsg.classList.add('hidden'); }

            loadAgencies();
            fetch(`${SCRIPT_URL}?action=getCheckinStats`).then(res => res.json()).then(data => { if(data.status === 'success') document.getElementById('checkin-count').innerText = data.count; });

            const isGeoEnabled = (APP_CONFIG.geo_enabled === 'true' || APP_CONFIG.geo_enabled === true);
            if (!isGeoEnabled) { 
                if(statusContainer) statusContainer.classList.add('hidden'); 
                btn.disabled = false; btn.classList.remove('bg-gray-400', 'cursor-not-allowed'); btn.classList.add('bg-navy', 'hover:bg-[#001a38]'); btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'; 
                document.getElementById('ci-coords').value = "online-no-gps"; 
                return; 
            } else { 
                if(statusContainer) statusContainer.classList.remove('hidden'); geoMsg.classList.add('hidden'); 
            }

            if (navigator.geolocation) {
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        document.getElementById('ci-coords').value = `${lat},${lng}`;
                        const targetLat = parseFloat(APP_CONFIG.target_lat);
                        const targetLng = parseFloat(APP_CONFIG.target_lng);
                        const radius = parseFloat(APP_CONFIG.allowed_radius);
                        const dist = getDistanceFromLatLonInKm(lat, lng, targetLat, targetLng);
                        if(dist <= radius) { statusDiv.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i> ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏´‡πà‡∏≤‡∏á ${dist.toFixed(2)} ‡∏Å‡∏°.)</span>`; btn.disabled = false; btn.classList.remove('bg-gray-400', 'cursor-not-allowed'); btn.classList.add('bg-navy', 'hover:bg-[#001a38]'); btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'; } 
                        else { statusDiv.innerHTML = `<span class="text-red-600"><i class="fas fa-times-circle"></i> ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô</span>`; btn.disabled = true; }
                    },
                    (error) => { statusDiv.innerHTML = `<span class="text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: ${error.message}</span>`; btn.disabled = true; }
                );
            } else { statusDiv.innerText = "Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation"; }
        }

        function loadAgencies() {
            const select = document.getElementById('ci-school');
            select.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
            fetch(`${SCRIPT_URL}?action=getAgencies`).then(res => res.json()).then(response => {
                if(response.status === 'success') {
                    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î --</option>';
                    response.data.forEach(school => { select.innerHTML += `<option value="${school}">${school}</option>`; });
                    select.innerHTML += `<option value="other">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏)</option>`;
                } else { select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>'; }
            }).catch(err => { console.error(err); select.innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>'; });
        }

        function toggleOtherSchoolInput(select) {
            const input = document.getElementById('ci-school-other');
            if(select.value === 'other') { input.classList.remove('hidden'); input.required = true; input.focus(); } 
            else { input.classList.add('hidden'); input.required = false; input.value = ''; }
        }

        function submitCheckin(e) {
            e.preventDefault();
            const mode = document.getElementById('ci-mode').value;
            const btn = document.getElementById('btn-ci-submit');
            
            // Check School Logic
            let school = document.getElementById('ci-school').value;
            if(!school) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î', 'warning'); return; }
            if(school === 'other') {
                school = document.getElementById('ci-school-other').value;
                if(!school.trim()) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î', 'warning'); return; }
            }

            // MODE 1: Manual
            if (mode === 'manual') {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;
                const payload = { 
                    action: 'checkIn', 
                    prefix: document.getElementById('ci-prefix').value, 
                    name: document.getElementById('ci-name').value, 
                    school: school, 
                    coords: document.getElementById('ci-coords').value 
                };
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) }).then(res => res.json()).then(data => {
                    if(data.status === 'success') { Swal.fire({ title: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏á‡∏≤‡∏ô', icon: 'success', confirmButtonColor: '#002147' }); document.getElementById('checkinForm').reset(); document.getElementById('ci-school-other').classList.add('hidden'); initCheckin(); } else { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', data.message, 'warning'); }
                }).catch(err => Swal.fire('Error', 'Connection Failed', 'error')).finally(() => { btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'; });
            
            // MODE 2: Excel Bulk
            } else {
                const fileInput = document.getElementById('ci-excel-file');
                if(!fileInput.files.length) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel', 'warning'); return; }
                
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...'; btn.disabled = true;
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    // Convert to JSON (Row 1 is header)
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    // Skip header, map data
                    // Assuming Col A = Prefix, Col B = Name
                    // Or header detection
                    const entries = [];
                    for(let i=1; i<jsonData.length; i++) {
                        const row = jsonData[i];
                        if(row && row.length >= 2) {
                            const p = row[0] || '';
                            const n = row[1] || '';
                            if(n) {
                                entries.push({
                                    prefix: p,
                                    name: n,
                                    school: school,
                                    coords: document.getElementById('ci-coords').value
                                });
                            }
                        }
                    }

                    if(entries.length === 0) {
                        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                        btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'; btn.disabled = false;
                        return;
                    }

                    // Send Bulk
                    btn.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${entries.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`;
                    fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'checkInBulk', entries: entries }) })
                    .then(res => res.json()).then(data => {
                        if(data.status === 'success') { 
                            Swal.fire({ title: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: data.message, icon: 'success', confirmButtonColor: '#002147' }); 
                            document.getElementById('checkinForm').reset(); 
                            document.getElementById('ci-school-other').classList.add('hidden');
                            toggleCheckinMode('manual'); // Reset view
                            initCheckin(); 
                        } else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message, 'error'); }
                    }).catch(err => Swal.fire('Error', 'Connection Failed', 'error')).finally(() => { btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'; btn.disabled = false; });
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // --- Other Logics (Register, Results, Cert, Admin) ---
        function initRegisterPage() { const form = document.getElementById('regForm'); const closedMsg = document.getElementById('reg-closed-msg'); const isActRegEnabled = (APP_CONFIG.activity_reg_enabled === 'true' || APP_CONFIG.activity_reg_enabled === true); if (!isActRegEnabled) { form.classList.add('hidden'); closedMsg.classList.remove('hidden'); } else { form.classList.remove('hidden'); closedMsg.classList.add('hidden'); if(activitiesList.length === 0) loadActivities(); } loadRegistrationHistory(); }
        function initRegisterForm() { const select = document.getElementById('reg-count'); select.innerHTML = ''; for(let i=1; i<=15; i++) select.innerHTML += `<option value="${i}">${i} ‡∏Ñ‡∏ô</option>`; renderStudentInputs(); }
        function loadActivities() { const select = document.getElementById('reg-activity'); select.innerHTML = '<option data-group="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>'; fetch(`${SCRIPT_URL}?action=getActivities`).then(res => res.json()).then(response => { if(response.status === 'success') { select.innerHTML = '<option value="" data-group="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô --</option>'; response.data.forEach(row => { let value = row[1]; if(row[2]) value = row[2]; const group = row[4] || '-'; let text = row[1]; if(row[2]) text = `${row[2]} (${row[1]})`; select.innerHTML += `<option value="${value}" data-group="${group}">${text}</option>`; }); } }); }
        function onActivityChange(selectElement) { const selectedOption = selectElement.options[selectElement.selectedIndex]; const group = selectedOption.getAttribute('data-group'); document.getElementById('reg-group').value = group || ''; }
        function renderStudentInputs() { const count = parseInt(document.getElementById('reg-count').value); const container = document.getElementById('student-inputs-container'); container.innerHTML = ''; for(let i=1; i<=count; i++) { const html = `<div class="flex gap-2 items-center"><span class="text-gray-500 w-6 font-bold text-center">${i}.</span><select class="border border-gray-300 rounded px-2 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-navy" name="prefix_${i}"><option>‡∏î.‡∏ä.</option><option>‡∏î.‡∏ç.</option><option>‡∏ô‡∏≤‡∏¢</option><option>‡∏ô.‡∏™.</option></select><input type="text" class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-navy" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" name="name_${i}" required></div>`; container.insertAdjacentHTML('beforeend', html); } }
        function submitRegistration(e) { e.preventDefault(); const btn = document.getElementById('btn-submit-reg'); const spinner = document.getElementById('spinner-reg'); const btnText = document.getElementById('btn-text-reg'); btn.disabled = true; btnText.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; spinner.classList.remove('hidden'); const count = parseInt(document.getElementById('reg-count').value); let students = []; for(let i=1; i<=count; i++) { const prefix = document.querySelector(`select[name="prefix_${i}"]`).value; const name = document.querySelector(`input[name="name_${i}"]`).value; students.push(`${prefix}${name}`); } const payload = { action: 'registerActivity', activity: document.getElementById('reg-activity').value, subjectGroup: document.getElementById('reg-group').value, studentCount: count, students: students, school: document.getElementById('reg-school').value, teacher: document.getElementById('reg-teacher').value, phone: document.getElementById('reg-phone').value }; fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) }).then(res => res.json()).then(data => { if(data.status === 'success') { Swal.fire({ title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', icon: 'success', confirmButtonColor: '#002147' }); document.getElementById('regForm').reset(); document.getElementById('reg-group').value = ''; initRegisterForm(); loadRegistrationHistory(); } else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message, 'error'); } }).catch(err => Swal.fire('Error', 'Connection Failed', 'error')).finally(() => { btn.disabled = false; btnText.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£"; spinner.classList.add('hidden'); }); }
        function loadRegistrationHistory() { const tbody = document.getElementById('reg-history-body'); const countBadge = document.getElementById('history-count-badge'); const refreshIcon = document.querySelector('#btn-refresh-history i'); if(refreshIcon) refreshIcon.classList.add('fa-spin'); tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8"><div class="loading-spinner w-8 h-8 border-4 border-navy rounded-full mx-auto"></div></td></tr>'; fetch(`${SCRIPT_URL}?action=getRegistrations`).then(res => res.json()).then(res => { if(res.status === 'success') { tbody.innerHTML = ''; countBadge.innerText = `(${res.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`; if(res.data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; } res.data.forEach(row => { let studentNames = '-'; try { const students = JSON.parse(row[7]); if(Array.isArray(students)) studentNames = students.map(s => `<div class="py-1 border-b border-gray-100 last:border-0">${s}</div>`).join(''); } catch(e) { studentNames = row[7]; } const dateObj = new Date(row[0]); const dateStr = !isNaN(dateObj) ? dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute:'2-digit' }) : row[0]; const html = `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-4 py-3 align-top text-gray-600">${dateStr}</td><td class="px-4 py-3 font-medium text-navy align-top">${row[1]}</td><td class="px-4 py-3 align-top text-gray-600"><span class="bg-blue-50 text-navy text-xs px-2 py-1 rounded border border-blue-100">${row[2]}</span></td><td class="px-4 py-3 align-top text-gray-700">${studentNames}</td><td class="px-4 py-3 align-top text-gray-600">${row[3]}</td></tr>`; tbody.insertAdjacentHTML('beforeend', html); }); } }).finally(() => { if(refreshIcon) refreshIcon.classList.remove('fa-spin'); }); }
        function loadResults() { const tbody = document.getElementById('result-table-body'); tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8"><div class="loading-spinner w-8 h-8 border-4 border-navy rounded-full mx-auto"></div></td></tr>'; fetch(`${SCRIPT_URL}?action=getResults`).then(res => res.json()).then(res => { if(res.status === 'success') { tbody.innerHTML = ''; if(res.data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</td></tr>'; return; } res.data.forEach(row => { let studentDisplay = row.students; try { const parsed = JSON.parse(row.students); if (Array.isArray(parsed)) studentDisplay = parsed.map(s => `<div class="py-0.5">${s}</div>`).join(''); } catch(e) { if(studentDisplay) studentDisplay = String(studentDisplay).replace(/[\["\]]/g, '').split(',').map(s => `<div class="py-0.5">${s.trim()}</div>`).join(''); } const html = `<tr class="bg-white border-b hover:bg-gray-50 search-item"><td class="px-4 py-3 font-medium text-navy">${row.activity}</td><td class="px-4 py-3"><span class="bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded border border-yellow-200">${row.rank}</span></td><td class="px-4 py-3 text-gray-700">${row.school}</td><td class="px-4 py-3 text-sm text-gray-600">${studentDisplay || '-'}</td><td class="px-4 py-3 font-bold text-gray-700">${row.score || '-'}</td></tr>`; tbody.insertAdjacentHTML('beforeend', html); }); } }); }
        function filterResultsTable() { const input = document.getElementById('filter-result').value.toLowerCase(); document.querySelectorAll('.search-item').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(input) ? '' : 'none'; }); }
        function searchCertificate() { const query = document.getElementById('cert-search-input').value.trim(); if(!query) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠', 'warning'); const area = document.getElementById('cert-result-area'); area.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin text-navy"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>'; fetch(`${SCRIPT_URL}?action=searchCert&q=${encodeURIComponent(query)}`).then(res => res.json()).then(res => { area.innerHTML = ''; if(res.data.length === 0) { area.innerHTML = '<div class="text-center text-red-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</div>'; return; } res.data.forEach(item => { const html = `<div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition"><div class="flex justify-between items-start mb-2"><div><div class="font-bold text-lg text-navy">${item.name}</div><div class="text-gray-600 text-sm"><i class="fas fa-school mr-1"></i> ${item.school}</div></div><div class="text-xs text-gray-400">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${item.certNo || '-'}</div></div><div class="text-sm text-gray-500 mb-3">${item.activity}</div><div class="text-right"><a href="${item.link}" target="_blank" class="inline-flex items-center bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm"><i class="fas fa-download mr-2"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</a></div></div>`; area.insertAdjacentHTML('beforeend', html); }); }).catch(err => { console.error(err); area.innerHTML = '<div class="text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>'; }); }
        function initAdmin() { document.getElementById('admin-login-view').classList.remove('hidden'); document.getElementById('admin-dashboard-view').classList.add('hidden'); }
        function adminLogin(e) { e.preventDefault(); const user = document.getElementById('login-user').value.trim(); const pass = document.getElementById('login-pass').value.trim(); if (user === String(APP_CONFIG.admin_username).trim() && pass === String(APP_CONFIG.admin_password).trim()) { document.getElementById('admin-login-view').classList.add('hidden'); document.getElementById('admin-dashboard-view').classList.remove('hidden'); loadAdminDashboardValues(); } else { Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); } }
        function adminLogout() { document.getElementById('admin-login-view').classList.remove('hidden'); document.getElementById('admin-dashboard-view').classList.add('hidden'); document.getElementById('login-user').value = ''; document.getElementById('login-pass').value = ''; }
        function loadAdminDashboardValues() { document.getElementById('toggle-reg').checked = (APP_CONFIG.registration_enabled === 'true' || APP_CONFIG.registration_enabled === true); document.getElementById('toggle-act-reg').checked = (APP_CONFIG.activity_reg_enabled === 'true' || APP_CONFIG.activity_reg_enabled === true); document.getElementById('toggle-geo').checked = (APP_CONFIG.geo_enabled === 'true' || APP_CONFIG.geo_enabled === true); document.getElementById('admin-lat').value = APP_CONFIG.target_lat; document.getElementById('admin-lng').value = APP_CONFIG.target_lng; document.getElementById('admin-radius').value = APP_CONFIG.allowed_radius; document.getElementById('toggle-popup').checked = (APP_CONFIG.popup_enabled === 'true' || APP_CONFIG.popup_enabled === true); document.getElementById('admin-popup-content').value = APP_CONFIG.popup_content; document.getElementById('admin-popup-target').value = APP_CONFIG.popup_link_target || 'checkin'; document.getElementById('admin-new-user').value = APP_CONFIG.admin_username; document.getElementById('admin-new-pass').value = APP_CONFIG.admin_password; }
        function getCurrentLocationForAdmin() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((position) => { document.getElementById('admin-lat').value = position.coords.latitude; document.getElementById('admin-lng').value = position.coords.longitude; Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success'); }); } else { Swal.fire('Error', 'Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS', 'error'); } }
        function saveAdminSettings() { const btn = document.getElementById('btn-save-settings'); btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true; const newSettings = { registration_enabled: document.getElementById('toggle-reg').checked ? 'true' : 'false', activity_reg_enabled: document.getElementById('toggle-act-reg').checked ? 'true' : 'false', geo_enabled: document.getElementById('toggle-geo').checked ? 'true' : 'false', target_lat: document.getElementById('admin-lat').value, target_lng: document.getElementById('admin-lng').value, allowed_radius: document.getElementById('admin-radius').value, popup_enabled: document.getElementById('toggle-popup').checked ? 'true' : 'false', popup_content: document.getElementById('admin-popup-content').value, popup_link_target: document.getElementById('admin-popup-target').value, admin_username: document.getElementById('admin-new-user').value, admin_password: document.getElementById('admin-new-pass').value }; fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateSettings', settings: newSettings }) }).then(res => res.json()).then(data => { if(data.status === 'success') { Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success'); APP_CONFIG = { ...APP_CONFIG, ...newSettings }; const isPopupEnabled = (newSettings.popup_enabled === 'true' || newSettings.popup_enabled === true); if(isPopupEnabled) { document.getElementById('popup-message').innerText = newSettings.popup_content; const popupBtn = document.getElementById('popup-action-btn'); if(newSettings.popup_link_target === 'checkin') popupBtn.innerText = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå'; else if(newSettings.popup_link_target === 'cert') popupBtn.innerText = '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£'; else if(newSettings.popup_link_target === 'register') popupBtn.innerText = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'; document.getElementById('homepage-popup').classList.remove('hidden'); } else { document.getElementById('homepage-popup').classList.add('hidden'); } const currentTab = document.querySelector('section:not(.hidden)').id.replace('page-', ''); if(currentTab === 'checkin') initCheckin(); if(currentTab === 'register') initRegisterPage(); } else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message, 'error'); } }).catch(err => Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error')).finally(() => { btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; btn.disabled = false; }); }
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) { var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; }
        function deg2rad(deg) { return deg * (Math.PI/180); }
    </script>
</body>
</html>
